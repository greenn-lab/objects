# í•©ì„±ê³¼ ìœ ì—°í•œ ê´€ê³„
ìƒì†ì€ **is-a ê´€ê³„**, í•©ì„±ì€ **has-a ê´€ê³„** ë¼ê³  í•´ìš”. ë˜ ìƒì†ì€ ì„œë¸Œ í´ë˜ìŠ¤ì— ì˜í•´ì„œ ì¬ì‚¬ìš©ëœë‹¤ê³ 
**í™”ì´íŠ¸ë°•ìŠ¤ ì¬ì‚¬ìš©(white-box reuse)**, í•©ì„±ì€ ë‚´ë¶€ì˜ ê³µê°œ ì—†ì´ ì¸í„°í˜ì´ìŠ¤ë¥¼ í†µí•´ì„œë§Œ ì¬ì‚¬ìš© ë˜ë¯€ë¡œ **ë¸”ë™ë°•ìŠ¤
ì¬ì‚¬ìš©(Black-box reuse)** ë¼ê³  ë¶€ë¥¸ëŒ€ìš”.

## 01 ìƒì†ì„ í•©ì„±ìœ¼ë¡œ ë³€ê²½í•˜ê¸°
ìƒì†ì´ ì¢‹ì§€ ì•Šì€ê²Œ,

- ë¶ˆí•„ìš”í•œ ì¸í„°í˜ì´ìŠ¤ ìƒì† ë¬¸ì œ
    - `java.util.Properties` ë‚˜ `java.util.Stack` ê°™ì€ ê²ƒë“¤.
- ë©”ì„œë“œ ì˜¤ë²„ë¼ì´ë”©ì˜ ì˜¤ì‘ë™ ë¬¸ì œ
    - `java.util.HashSet` ì„ ìƒì†ë°›ëŠ” `InstrumentedHashSet` ê°™ì´ ë¶€ëª¨ í´ë˜ìŠ¤ì˜ ë©”ì„œë“œë¥¼
        í˜¸ì¶œí•  ë•Œ ë¬¸ì œê°€ ë°œìƒë˜ëŠ” ê²ƒ.
- ë¶€ëª¨ í´ë˜ìŠ¤ì™€ ìì‹ í´ë˜ìŠ¤ì˜ ë™ì‹œ ìˆ˜ì • ë¬¸ì œ

ì´ëŸ° ì´ìœ ë¡œ ìƒì†ì„ í•©ì„±ìœ¼ë¡œ ë³€ê²½í•˜ëŠ” ê±°ì£ .

### ë¶ˆí•„ìš”í•œ ì¸í„°í˜ì´ìŠ¤ ìƒì† ë¬¸ì œ: `Properties` ì™€ `Stack`
ì„ ì–¸ëœ ë¶€ëª¨ í´ë˜ìŠ¤ë¥¼ í•„ë“œ ì¸ìŠ¤í„´ìŠ¤ë¡œ ë§Œë“¤ë©´ ë!

```java
class Properties { 
  private Hashtable<String, String> properties = new Hashtable<>();
  
  public String setProperty(String key, String value) {
    return this.properties.put(key, value);
  }
  
  public String getProperty(String key) {
    return this.properties.get(key);
  }
} 
```
ì´ëŸ¬ë©´ `String` íƒ€ì…ì˜ í‚¤ì™€ ê°’ìœ¼ë¡œ ì œì•½ëœ ê·œì¹™ì„ ì¤€ìˆ˜í•  ìˆ˜ ìˆì–´ìš”.

```java
import java.util.EmptyStackException;class Stack<E> {
  private java.util.Vector<E> elements = new Vector<>();

  public E push(E item) {
    elements.addElement(item);
    return item;
  }
  
  public E pop() {
    if (elements.isEmpty())
      throw new EmptyStackException();

    return elements.get(elements.size() - 1);
  }
}
```
`push(...)` ë¡œ íŠ¹ì • ìˆœì„œì— ê°ì²´ë¥¼ ì ì¬í•˜ëŠ” ë¬¸ì œë¥¼ í•´ê²°í•´ìš”. ì§„ì •í•œ ìŠ¤íƒ ìë£Œêµ¬ì¡°ê°€ êµ¬í˜„ëì–´ìš”, ì§œì”~ğŸ‘ğŸ‘

### ë©”ì„œë“œ ì˜¤ë²„ë¼ì´ë”©ì˜ ì˜¤ì‘ìš© ë¬¸ì œ: InstrumentedHashSet
`Stack` ê³¼ `Properties` ì™€ëŠ” ì¢€ ë‹¤ë¥¸ê²Œ, `InstrumentedHashSet` ì€ `Set` interface
ë¥¼ êµ¬í˜„í•´ì•¼ í•´ìš”.

```java
class InstrumentedHashSet<E> implements Set<E> {
  private int addCount = 0;
  private Set<E> set;
  
  public InstrumentedHashSet(Set<E> set) {
    this.set = set;
  }
  
  @Override
  public boolean add(E item) {
    addCount ++;
    return set.add(item);
  }
  
  @Override
  public boolean addAll(Collection<? extends E> items) {
    addCount += items.size();
    return set.addAll(items);
  }
  
  public int getAddCount() {
    return this.addCount;
  }
  
  @Override public boolean remove(E item) { return set.remove(item); }
  @Override public void clear() { set.clear(); }
  // ...
}
```

### ë¶€ëª¨ í´ë˜ìŠ¤ì™€ ìì‹ í´ë˜ìŠ¤ ë™ì‹œ ìˆ˜ì • ë¬¸ì œ: `PersonalPlaylist`
í•©ì„±ì„ í•´ë„ ì–´ì©” ìˆ˜ ì—†ì´ ì—°ê´€ëœ í´ë˜ìŠ¤ë¥¼ ë™ì‹œì— ìˆ˜ì •í•˜ëŠ” ë¬¸ì œì—ì„œ ë²—ì–´ ë‚  ìˆ˜ ì—†ëŠ” ê²½ìš°ê°€ ìˆëŠ”ë°, ê·¸ë ‡ë‹¤í•´ë„ ë³€ê²½ì— ëŒ€í•œ íŒŒê¸‰
íš¨ê³¼ë¥¼ ë”°ì§€ë©´ ìƒì†ë³´ë‹¨ í•©ì„±ì´ë˜ìš”.  
ì•ˆì •ì„±ê³¼ ìœ ì—°ì„±ì„ ë” ë³´ì¥ ë°›ëŠ” ê²ƒ ê°™ì•„ìš”.

## 02 ìƒì†ìœ¼ë¡œ ì¸í•œ ì¡°í•©ì˜ í­ë°œì ì¸ ì¦ê°€
ì •ì±…ì´ ì¶”ê°€ë˜ëŠ” ê±¸ ìƒì†ìœ¼ë¡œ êµ¬í˜„í•˜ë©´ì„œ í´ë˜ìŠ¤ì˜ í­ë°œğŸ’£ ë¬¸ì œë¥¼ ê²ªê²Œ ë˜ëŠ” ê±°ì£ .
https://github.com/eternity-oop/object/tree/master/chapter11/src/main/java/org/eternity/billing/step04
ì½”ë“œëŠ” ë„ˆë¬´ ê¸°ì´ì´ì´ì´ì´ì´ì´ë‹ˆê¹Œ...

## 03 í•©ì„± ê´€ê³„ë¡œ ë³€ê²½í•˜ê¸°
![](./11-001.png)  
ì´ ê·¸ë¦¼ì€ ê¸°ë³¸ ì •ì±…ê³¼ ë¶€ê°€ ì •ì±…ì„ ë…ë¦½ì ì¸ ë°•ìŠ¤ë¡œ í‘œí˜„í•˜ê³  ìˆœì„œì— ë”°ë¼ ì¡°í•©ëì–´ìš”.  
ì´ê²Œ ë°”ë¡œ í•©ì„±ì˜ ë³¸ì§ˆì´ë¼ë„¤ìš”.

### ê¸°ë³¸ ì •ì±… í•©ì„±í•˜ê¸°

ì œì¼ ë¨¼ì € ê¸°ë³¸ ì •ì±…ê³¼ ë¶€ê°€ ì •ì±…ì„ í¬ê´„í•˜ëŠ” ê±¸ í•˜ë‚˜ ë§Œë“¤ì–´ìš”.
```java
interface RatePolicy {
  Money calculateFee(Phone phone);
} 
```
ê¸°ë³¸ ì •ì±…ì„ êµ¬í˜„í•´ìš”.
```java
abstract class BasicRatePolicy implements RatePolicy {
  @Override
  public Money calculateFee(Phone phone) {
    Money result = Money.ZERO;
    
    for (Call call : phone.getCalls())
      result.plus(calculateCallFee(call));
  }
  
  protected abstract Money calculateCallFee(Call call);
}
```
ì´ì œ ê¸°ë³¸ì •ì±…ì— í•´ë‹¹í•˜ëŠ” ì¼ë°˜ìš”ê¸ˆì œ, ì‹¬ì•¼í• ì¸ìš”ê¸ˆì œë¥¼ êµ¬í˜„ í•´ìš”.
```java
@RequiredArgsConstructor
class RegularPolicy extends BasicRatePolicy {
  private final Money amount;
  private final Duration seconds;
  
  @Override
  protected Money calculateCallFee(Call call) {
    return amount.times(call.getDuration().getSeconds()
            / this.seconds.getSeconds());
  }
}

@RequiredArgsConstructor
class NightlyDiscountPolicy extends BasicRatePolicy {
  private static final int LATE_NIGHT_HOUR = 22;

  private final Money nightlyAmount;
  private final Money regularAmount;
  private final Duration seconds;
  
  @Override
  protected Money calculateCallFee(Call call) {
    if (call.getFrom().getHour() >= LATE_NIGHT_HOUR)
      return nightlyAmount.times(call.getDuration().getSeconds()
            / this.seconds.getSeconds());
    
    return regularAmount.times(call.getDuration().getSeconds()
            / this.seconds.getSeconds());
  }
}
```
ì§€ê¸ˆê¹Œì§€ ê°€ê¾¼ ë‹¤í˜•ì„±ì˜ ì•„ë¦„ë‹¤ìš´ ê½ƒì„ í”¼ì›Œë´ìš”.
```java
@RequiredArgsConstructor
class Phone {
  private final RatePolicy ratePolicy;
  private List<Call> calls = new ArrayList<>();
  
  public List<Call> getCalls() {
    return Collections.unmodifiableList(this.calls);
  }
  
  public Money calculateFee() {
    return ratePolicy.calculateFee(this);
  }
}
```
í•„ë“œë¡œ `RatePolicy` ê°€ ìˆì£ . ì´ê²ƒì´ ë°”ë¡œ í•©ì„±ì´ë¼ê³  ê°•ì¡°í•´ìš”. ì´ë ‡ê²Œ êµ¬í˜„í•œ ê±¸ ë‹¤ì´ì–´ê·¸ë¨ìœ¼ë¡œ í‘œí˜„í•˜ë©´  
![](./11-002.svg)

ê´œì°®ë„¤ìš”.

ì¼ë°˜ìš”ê¸ˆì œì˜ ìš”ê¸ˆ ê³„ì‚°ì€
```java
RatePolicy regularPolicy = new RegularPolicy(
    Money.won(10), 
    Duration.ofSeconds(10));
Phone phone = new Phone(regularPolicy);
```
ì´ëŸ¬ë©´ ë˜ê³ , ì•¼ë°¤í• ì¸ì€
```java
RatePolicy regularPolicy = new NightlyDiscountPolicy(
    Money.won(5), 
    Money.won(10), 
    Duration.ofSeconds(10));
Phone phone = new Phone(regularPolicy);
```

ë¶€ê°€ ì •ì±…ì€ ì¶”ìƒ í´ë˜ìŠ¤ë¡œ ë§Œë“¤ì–´ìš”.
```java
@AllArgsConstructor
abstract class AdditionalRatePolicy implements RatePolicy {
  private RatePolicy next;
  
  @Override
  public Money calculateFee(Phone phone) {
    Money fee = next.calculateFee(phone);
    return afterCalculated(fee);
  }
  
  protected abstract Money afterCalculated(Money fee);
} 
```

ì¢‹ì•„ìš”, ë§˜ì— ë“¤ì–´ìš”. ğŸ˜€  
ì—¬ê¸°ì— ì„¸ê¸ˆì •ì±… ì„ ë§Œë“¤ë©´,
```java
class TaxablePolicy extends AdditionalRatePolicy {
  private double taxRatio;
  
  public TaxablePolicy(double taxRatio, RatePolicy next) {
    super(next);
    this.taxRatio = taxRatio;
  }
  
  @Override
  protected Money afterCalculated(Money fee) {
    return fee.plus(fee.times(this.taxRatio));
  }
}
```
ê¸°ë³¸ìš”ê¸ˆ í• ì¸ ì •ì±…ë„,
```java
class RateDiscountableDPolicy extends AdditionalRatePolicy {
  private Money discountAmount;
  
  public TaxablePolicy(Money discountAmount, RatePolicy next) {
    super(next);
    this.discountAmount = discountAmount;
  }
  
  @Override
  protected Money afterCalculated(Money fee) {
    return fee.minus(this.discountAmount);
  }
}
```
ì™„ë²½í•´ìš”. ğŸ¤“

![](./11-003.svg)

### ê¸°ë³¸ ì •ì±…ê³¼ ë¶€ê°€ ì •ì±… í•©ì„±í•˜ê¸°

ë§Œë“¤ì—ˆë˜ ê±¸ ì‚¬ìš©í•˜ë©´,
```java
// ì„¸ê¸ˆì •ì±…
RatePolicy taxablePolicy
    = new TaxablePolicy(0.05D, new RegularPolicy(...));

new Phone(taxablePolicy);

// ê¸°ë³¸ ìš”ê¸ˆ í• ì¸ ì •ì±… + ì„¸ê¸ˆ ì •ì±…
RatePolicy rateAndTaxPolicy
    = new RateDiscountablePolicy(
        Money.won(1000), taxablePolicy);

new Phone(rateAndTaxPolicy);
```
êµ¿~ğŸ‘

## 04 ë¯¹ìŠ¤ì¸
ê°ì²´ë¥¼ ìƒì„±í•  ë•Œ ì½”ë“œ ì¼ë¶€ë¥¼ í´ë˜ìŠ¤ ì•ˆì— ì„ì–´ ë„£ì–´ ì¬ì‚¬ìš©í•˜ëŠ” ë°©ë²•ì„ ë¯¹ìŠ¤ì¸ ì´ë¼ê³  í•˜ëŠ”êµ°ìš”.  
ì „í™” ìš”ê¸ˆ ì •ì±…ì„ êµ¬í˜„í–ˆì„ ë•Œ, `next.calculateFee(...)` ê°™ì´ ë©”ì„œë“œ ê¸°ëŠ¥ì„ í™•ì¥í•˜ëŠ” ê±¸.

ì¬ë°Œì—ˆë„¤ìš”, ì´ë²ˆ ì±•í„°ë„!
